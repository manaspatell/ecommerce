<%- include('../partials/header', { title: product ? 'Edit Product' : 'Add Product' }) %>

<div class="container mt-4">
    <h1 class="mb-4">
        <i class="bi bi-<%= product ? 'pencil' : 'plus-circle' %>"></i> 
        <%= product ? 'Edit Product' : 'Add New Product' %>
    </h1>

    <% if (typeof error !== 'undefined' && error) { %>
        <div class="alert alert-danger"><%= error %></div>
    <% } %>

    <form method="POST" action="<%= product ? '/admin/products/edit/' + product._id : '/admin/products/create' %>" 
          enctype="multipart/form-data">
        <div class="row">
            <div class="col-md-8">
                <div class="card mb-3">
                    <div class="card-header">Basic Information</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Product Name *</label>
                            <input type="text" class="form-control" name="name" 
                                   value="<%= product ? product.name : '' %>" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Category *</label>
                            <select class="form-select" name="category_id" required>
                                <option value="">Select Category</option>
                                <% categories.forEach(cat => { %>
                                    <option value="<%= cat._id %>" 
                                            <%= product && product.category_id && product.category_id._id.toString() === cat._id.toString() ? 'selected' : '' %>>
                                        <%= cat.name %>
                                    </option>
                                <% }); %>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="5"><%= product ? product.description : '' %></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Price (₹) *</label>
                                <input type="number" class="form-control" name="price" 
                                       value="<%= product ? product.price : '' %>" step="0.01" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">SKU</label>
                                <input type="text" class="form-control" name="sku" 
                                       value="<%= product ? product.sku : '' %>">
                            </div>
                        </div>
                        <div class="card mb-3" style="background-color: #fff3cd; border: 1px solid #ffc107;">
                            <div class="card-header" style="background-color: #ffc107;">
                                <strong>Discount Settings</strong>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" name="discount_enabled" id="discountEnabled"
                                               <%= product && product.discount && product.discount.enabled ? 'checked' : '' %>>
                                        <label class="form-check-label" for="discountEnabled">
                                            <strong>Enable Discount</strong>
                                        </label>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Discount Percentage (%)</label>
                                    <input type="number" class="form-control" name="discount_percentage" 
                                           id="discountPercentage"
                                           value="<%= product && product.discount ? product.discount.percentage : 0 %>" 
                                           min="0" max="100" step="1"
                                           <%= product && product.discount && product.discount.enabled ? '' : 'disabled' %>>
                                    <small class="text-muted">Enter discount percentage (0-100)</small>
                                </div>
                                <div id="discountPreview" class="alert alert-info" style="display: none;">
                                    <strong>Preview:</strong> 
                                    <span id="previewText"></span>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tags (comma separated)</label>
                            <input type="text" class="form-control" name="tags" 
                                   value="<%= product && product.tags ? product.tags.join(', ') : '' %>"
                                   placeholder="electronics, tv, smart">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" name="status">
                                <option value="active" <%= product && product.status === 'active' ? 'selected' : '' %>>Active</option>
                                <option value="inactive" <%= product && product.status === 'inactive' ? 'selected' : '' %>>Inactive</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header">Specifications (Key: Value format, one per line)</div>
                    <div class="card-body">
                        <textarea class="form-control" name="specifications" rows="5" 
                                  placeholder="Screen Size: 55 inches&#10;Resolution: 4K UHD&#10;Smart TV: Yes"><% 
                            if (product && product.specifications) {
                                // Handle both Map and plain object
                                let specsObj = {};
                                if (product.specifications instanceof Map) {
                                    product.specifications.forEach((value, key) => {
                                        specsObj[key] = value;
                                    });
                                } else {
                                    specsObj = product.specifications;
                                }
                                Object.entries(specsObj).forEach(([key, value]) => {
                                    %><%= key %>: <%= value %>
<%                              });
                            }
                        %></textarea>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header">Product Images</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Upload Images</label>
                            <input type="file" class="form-control" name="images" multiple accept="image/*">
                            <small class="text-muted">You can select multiple images</small>
                        </div>
                        <% if (product && product.images && product.images.length > 0) { %>
                            <div class="mb-3">
                                <label class="form-label">Current Images</label>
                                <div class="row g-2">
                                    <% product.images.forEach((img, idx) => { %>
                                        <div class="col-6">
                                            <div class="admin-image-preview">
                                                <img src="<%= img %>" 
                                                     class="img-thumbnail admin-preview-img" 
                                                     style="width: 100%; height: 150px; object-fit: contain; background-color: #f0f0f0; position: relative; z-index: 2;"
                                                     alt="Product Image <%= idx + 1 %>"
                                                     onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect width=\'200\' height=\'200\' fill=\'%23ddd\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3EImage Not Found%3C/text%3E%3C/svg%3E'; this.style.backgroundColor='#f0f0f0';">
                                            </div>
                                            <small class="d-block text-muted mt-1" style="word-break: break-all;"><%= img %></small>
                                            <button type="button" class="btn btn-sm btn-danger w-100 mt-1" 
                                                    onclick="deleteImage('<%= product._id %>', '<%= img %>')">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                        </div>
                                    <% }); %>
                                </div>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-4">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> <%= product ? 'Update' : 'Create' %> Product
            </button>
            <a href="/admin/products" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
function deleteImage(productId, imagePath) {
    if (!confirm('Are you sure you want to delete this image?')) return;
    
    fetch('/admin/products/delete-image', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ productId, imagePath })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to delete image');
        }
    });
}

// Discount toggle functionality
document.getElementById('discountEnabled')?.addEventListener('change', function() {
    const discountPercentage = document.getElementById('discountPercentage');
    const discountPreview = document.getElementById('discountPreview');
    
    if (this.checked) {
        discountPercentage.disabled = false;
        updateDiscountPreview();
    } else {
        discountPercentage.disabled = true;
        discountPreview.style.display = 'none';
    }
});

// Update discount preview
function updateDiscountPreview() {
    const priceInput = document.querySelector('input[name="price"]');
    const discountEnabled = document.getElementById('discountEnabled');
    const discountPercentage = document.getElementById('discountPercentage');
    const discountPreview = document.getElementById('discountPreview');
    const previewText = document.getElementById('previewText');
    
    if (discountEnabled && discountEnabled.checked && priceInput && discountPercentage) {
        const price = parseFloat(priceInput.value) || 0;
        const percentage = parseFloat(discountPercentage.value) || 0;
        
        if (price > 0 && percentage > 0) {
            const discountedPrice = price * (1 - percentage / 100);
            previewText.textContent = `Original: ₹${price.toLocaleString()} → Discounted: ₹${Math.round(discountedPrice).toLocaleString()} (${percentage}% OFF)`;
            discountPreview.style.display = 'block';
        } else {
            discountPreview.style.display = 'none';
        }
    } else {
        discountPreview.style.display = 'none';
    }
}

// Add event listeners for discount preview
document.querySelector('input[name="price"]')?.addEventListener('input', updateDiscountPreview);
document.getElementById('discountPercentage')?.addEventListener('input', updateDiscountPreview);
</script>

<%- include('../partials/footer') %>

