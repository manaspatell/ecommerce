<%- include('../partials/header', { title: 'Products' }) %>

<div class="container my-5">
    <div class="row">
        <div class="col-md-3">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>Filter by Category</h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <a href="/products" class="list-group-item list-group-item-action <%= currentCategory === 'all' ? 'active' : '' %>">
                            All Categories
                        </a>
                        <% categories.forEach(cat => { %>
                            <a href="/products?category=<%= cat.slug %>" 
                               class="list-group-item list-group-item-action <%= currentCategory === cat.slug ? 'active' : '' %>">
                                <%= cat.name %>
                            </a>
                        <% }); %>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Products</h1>
                <% if (search) { %>
                    <p class="text-muted">Search results for: "<%= search %>"</p>
                <% } %>
            </div>

            <div class="row g-4">
                <% if (products && products.length > 0) { %>
                    <% products.forEach(product => { %>
                        <div class="col-md-4 col-sm-6">
                            <div class="card product-card h-100 shadow-sm position-relative">
                                <% if (product.discount && product.discount.enabled && product.discount.percentage > 0) { %>
                                    <div class="discount-badge"><%= product.discount.percentage %>% OFF</div>
                                <% } %>
                                <a href="/product/<%= product.slug %>">
                                    <img src="<%= product.images && product.images.length > 0 ? product.images[0] : 'data:image/svg+xml,%3Csvg xmlns=\"http://www.w3.org/2000/svg\" width=\"200\" height=\"200\"%3E%3Crect width=\"200\" height=\"200\" fill=\"%23ddd\"/%3E%3Ctext x=\"50%25\" y=\"50%25\" text-anchor=\"middle\" dy=\".3em\" fill=\"%23999\"%3ENo Image%3C/text%3E%3C/svg%3E' %>" 
                                         class="card-img-top" style="height: 200px; object-fit: cover; background-color: #f0f0f0;" alt="<%= product.name %>"
                                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'200\' height=\'200\'%3E%3Crect width=\'200\' height=\'200\' fill=\'%23ddd\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\'%3ENo Image%3C/text%3E%3C/svg%3E'; this.style.backgroundColor='#f0f0f0';">
                                </a>
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <a href="/product/<%= product.slug %>" class="text-decoration-none text-dark">
                                            <%= product.name %>
                                        </a>
                                    </h6>
                                    <p class="text-muted small"><%= product.category_id ? product.category_id.name : '' %></p>
                                    <div class="mb-2">
                                        <% 
                                        let finalPrice = product.price;
                                        if (product.discount && product.discount.enabled && product.discount.percentage > 0) {
                                            finalPrice = product.price * (1 - product.discount.percentage / 100);
                                        %>
                                            <span class="price-original">₹<%= product.price.toLocaleString() %></span>
                                            <span class="price-discounted">₹<%= Math.round(finalPrice).toLocaleString() %></span>
                                        <% } else { %>
                                            <span class="price-discounted">₹<%= product.price.toLocaleString() %></span>
                                        <% } %>
                                    </div>
                                    <button class="btn btn-inquiry btn-sm w-100" data-product-id="<%= product._id %>" data-product-name="<%= product.name %>" data-action="inquiry">
                                        <i class="bi bi-envelope"></i> Send Inquiry
                                    </button>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="col-12 text-center">
                        <p class="text-muted">No products found.</p>
                    </div>
                <% } %>
            </div>

            <% if (totalPages > 1) { %>
                <nav class="mt-4">
                    <ul class="pagination justify-content-center">
                        <% for (let i = 1; i <= totalPages; i++) { %>
                            <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                                <a class="page-link" href="?page=<%= i %>&category=<%= currentCategory %>&search=<%= search || '' %>">
                                    <%= i %>
                                </a>
                            </li>
                        <% } %>
                    </ul>
                </nav>
            <% } %>
        </div>
    </div>
</div>

<!-- Inquiry Modal -->
<div class="modal fade" id="inquiryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Send Inquiry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body inquiry-form">
                <form id="inquiryForm">
                    <input type="hidden" id="inquiryProductId" name="product_ids">
                    <input type="hidden" id="inquiryProductName" name="product_name">
                    <div class="mb-3">
                        <label class="form-label">Full Name *</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone Number *</label>
                        <input type="tel" class="form-control" name="phone" required placeholder="Enter your number here">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Gmail Email *</label>
                        <input type="email" class="form-control" name="email" required placeholder="yourname@gmail.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Product Name</label>
                        <input type="text" class="form-control" id="displayProductName" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Product ID</label>
                        <input type="text" class="form-control" id="displayProductId" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message (Optional)</label>
                        <textarea class="form-control" name="message" rows="4" placeholder="Any additional information..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-inquiry w-100 mb-2">Send Inquiry</button>
                    <a href="tel:+919171310766" class="btn btn-outline-primary w-100">
                        <i class="bi bi-telephone-fill"></i> Call Directly: +91 9171310766
                    </a>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Make sendProductInquiry globally available
window.sendProductInquiry = function(productId, productName) {
    const inquiryModal = document.getElementById('inquiryModal');
    if (inquiryModal) {
        const productIdInput = document.getElementById('inquiryProductId');
        const productNameInput = document.getElementById('inquiryProductName');
        const displayProductName = document.getElementById('displayProductName');
        const displayProductId = document.getElementById('displayProductId');
        
        if (productIdInput) productIdInput.value = productId;
        if (productNameInput) productNameInput.value = productName || '';
        if (displayProductName) displayProductName.value = productName || 'Product';
        if (displayProductId) displayProductId.value = productId;
        
        const modal = new bootstrap.Modal(inquiryModal);
        modal.show();
    }
};

// Handle inquiry buttons using event delegation (CSP compliant)
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('[data-action="inquiry"]');
        if (btn) {
            const productId = btn.getAttribute('data-product-id');
            const productName = btn.getAttribute('data-product-name');
            if (productId) {
                sendProductInquiry(productId, productName);
            }
        }
    });
});

document.getElementById('inquiryForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    if (data.product_ids) data.product_ids = [data.product_ids];
    if (data.product_name && !data.message) {
        data.message = `Inquiry for: ${data.product_name}`;
    } else if (data.product_name && data.message) {
        data.message = `Inquiry for: ${data.product_name}\n\n${data.message}`;
    }
    
    try {
        const response = await fetch('/inquiry', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            alert('✅ Your inquiry has been received! We will contact you shortly.');
            bootstrap.Modal.getInstance(document.getElementById('inquiryModal')).hide();
            e.target.reset();
        } else {
            alert('❌ ' + result.message);
        }
    } catch (error) {
        alert('❌ Failed to send inquiry. Please try again or call us directly at +91 9171310766');
    }
});
</script>

<%- include('../partials/footer') %>

